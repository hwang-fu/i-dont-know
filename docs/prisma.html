<!-- * * * * * * * * * * * * * * -->
<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Prisma</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/plugins/line-numbers/prism-line-numbers.min.css">

    <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs/plugins/autoloader/prism-autoloader.min.js"
            data-prismjs-autoloader-path="https://cdn.jsdelivr.net/npm/prismjs/components/"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs/plugins/line-numbers/prism-line-numbers.min.js"></script>

<style>
    html {
        scroll-behavior: smooth;
    }

    .back-to-top {
        position: fixed;
        right: 20px;
        bottom: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #333;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        font-size: 22px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        opacity: 0.75;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 999;
    }

    .back-to-top:hover {
        opacity: 1;
        transform: translateY(-2px);
    }

    .nav-icon {
        width: 38px;
        height: 38px;
        object-fit: contain;
        vertical-align: middle;
        margin-left: 0.3rem;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-family: "KaiTi", "楷体", "STKaiti", "Kaiti SC", "Times New Roman", Georgia, serif;
        font-size: 14px;
    }

    th {
        background-color: #f5f5f5;
        text-align: left;
        font-weight: 600;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px 12px;
    }

    tr:nth-child(even) {
        background-color: #fafafa;
    }

    tr:hover {
        background-color: #f0f8ff;
    }

    .comment {
        color: grey;
    }

    .token.keyword {
        font-weight: 500;
    }

    .red-underline {
        text-decoration-line: underline;
        text-decoration-color: red;
        text-decoration-thickness: 2px;
        text-underline-offset: 2px;
    }

    body {
        font-family: "KaiTi", "楷体", "STKaiti", "Kaiti SC", "Times New Roman", Georgia, serif;
        font-variant-ligatures: none;
    }

    ul > li {
        list-style-type: disc;
    }

    code {
        color: #24292e;
        background-color: #f6f8fa;
        border: 1px solid #d0d7de;
        border-radius: .375rem;
        padding: .05rem .35rem;
        font-family: "FiraCode Nerd Font", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: 0.775rem;
        line-height: 1.1;
    }


    pre {
        margin: 1rem 0;
        padding: .8rem 1rem;
        background-color: #f6f8fa;
        border: 1px solid #d0d7de;
        border-radius: .5rem;
        overflow: auto;
        tab-size: 4;
    }


    pre code {
        display: block;
        padding: 0;
        background: transparent;
        border: 0;
        color: #24292e;
        font-family: "FiraCode Nerd Font", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-size: 0.875rem;
        line-height: 1.5;
        white-space: pre;
    }
</style>
</head>
<!-- * * * * * * * * * * * * * * -->
<body>
<a href="#" class="back-to-top" aria-label="Back to top">
    &#8593;
</a>
<!-- * * * * * * * * * * * * * * -->


<!-- * * * * * * * * * * * * * * -->
<hr/>
<nav id="toc" style="margin-bottom: 2rem;">
    <h2> <img src="resources/prisma.png" alt="Logo" class="nav-icon"/> </h2>
    <ol style="line-height: 1.8;">
        <li><a href="#prisma-introduction">Introduction</a></li>
        <li><a href="#prisma-database-connections">Database Connection Configuration</a></li>
        <li><a href="#prisma-connection-pooling">Connection Pooling vs Direct Connection</a></li>
    </ol>
</nav>
<hr/>
<!-- * * * * * * * * * * * * * * -->


<!-- * * * * * * * * * * * * * * -->
<h3 id="prisma-introduction">Introduction to Prisma ORM</h3>
<ol>

    <li>What Is Prisma?</li>
    <br/>
    <ul>
        <li><b>Prisma</b> is a modern, type-safe ORM (Object-Relational Mapping) for Node.js and TypeScript.</li>
        <br/>
        <li>Prisma is not just an ORM - it's a complete database toolkit that includes:</li>
        <ul>
            <li><code>Prisma Client</code>: auto-generated query builder</li>
            <li><code>Prisma Migrate</code>: declarative database migrations</li>
            <li><code>Prisma Studio</code>: visual database editor</li>
        </ul>
        <br/>
        <li>Official website: <code>https://www.prisma.io</code></li>
    </ul>
    <br/><br/>


    <li>Why Use Prisma?</li>
    <br/>
    <ul>
        <li>Prisma solves common problems with traditional ORMs:</li>
        <br/>
<table>
    <thead>
        <tr>
            <th>Traditional ORMs</th>
            <th>Prisma</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Complex entity classes</td>
            <td>Simple schema definition</td>
        </tr>
        <tr>
            <td>Runtime type safety issues</td>
            <td>Compile-time type safety</td>
        </tr>
        <tr>
            <td>Poor TypeScript support</td>
            <td>First-class TypeScript support</td>
        </tr>
        <tr>
            <td>N+1 query problems</td>
            <td>Optimized query generation</td>
        </tr>
        <tr>
            <td>Manual migration scripts</td>
            <td>Declarative migrations</td>
        </tr>
        <tr>
            <td>Complex query builder APIs</td>
            <td>Intuitive, readable API</td>
        </tr>
    </tbody>
</table>
    </ul>
    <br/><br/>


    <li>Supported Databases</li>
    <br/>
    <ul>
        <li>Prisma supports major relational and NoSQL databases:</li>
        <br/>
<table>
    <thead>
        <tr>
            <th>Database</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>PostgreSQL</td>
            <td>✓ Fully supported</td>
        </tr>
        <tr>
            <td>MySQL</td>
            <td>✓ Fully supported</td>
        </tr>
        <tr>
            <td>SQLite</td>
            <td>✓ Fully supported</td>
        </tr>
        <tr>
            <td>SQL Server</td>
            <td>✓ Fully supported</td>
        </tr>
        <tr>
            <td>MongoDB</td>
            <td>✓ Fully supported</td>
        </tr>
        <tr>
            <td>CockroachDB</td>
            <td>✓ Fully supported</td>
        </tr>
        <tr>
            <td>PlanetScale</td>
            <td>✓ Fully supported</td>
        </tr>
    </tbody>
</table>
        <br/>
        <li>Database-specific features are supported where available (enums, JSON types, etc.).</li>
    </ul>
    <br/><br/>


    <li>Core Concepts</li>
    <br/>
    <ul>
        <li><b>Prisma Schema:</b> A single source of truth for your database structure.</li>
<pre><code class="language-prisma line-numbers">// schema.prisma
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  posts     Post[]
  createdAt DateTime @default(now())
}</code></pre>
        <br/>
        <li><b>Prisma Client:</b> Auto-generated, type-safe database client.</li>
<pre><code class="language-typescript line-numbers">import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

// Type-safe query
const user = await prisma.user.findUnique({
  where: { email: 'alice@example.com' }
})</code></pre>
        <br/>
        <li><b>Migrations:</b> Version-controlled database schema changes.</li>
<pre><code class="language-bash line-numbers">npx prisma migrate dev --name add_user_model</code></pre>
        <br/>
        <li><b>Prisma Studio:</b> Visual database browser and editor.</li>
<pre><code class="language-bash line-numbers">npx prisma studio</code></pre>
    </ul>
    <br/><br/>


    <li>Installation and Setup</li>
    <br/>
    <ul>
        <li>Install Prisma in your Node.js project:</li>
<pre><code class="language-bash line-numbers">npm install prisma --save-dev
npm install @prisma/client</code></pre>
        <br/>
        <li>Initialize Prisma in your project:</li>
<pre><code class="language-bash line-numbers">npx prisma init</code></pre>
        <br/>
        <li>This creates:</li>
<pre><code class="language-plaintext line-numbers">project/
├── prisma/
│   └── schema.prisma
└── .env</code></pre>
        <br/>
        <li>Configure database connection in <code>.env</code>:</li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:password@localhost:5432/mydb"</code></pre>
        <br/>
        <li>Example for different databases:</li>
<pre><code class="language-plaintext line-numbers"># PostgreSQL
DATABASE_URL="postgresql://user:password@localhost:5432/mydb?schema=public"

# MySQL
DATABASE_URL="mysql://user:password@localhost:3306/mydb"

# SQLite
DATABASE_URL="file:./dev.db"

# SQL Server
DATABASE_URL="sqlserver://localhost:1433;database=mydb;user=sa;password=Password123"

# MongoDB
DATABASE_URL="mongodb://user:password@localhost:27017/mydb"</code></pre>
    </ul>
    <br/><br/>


    <li>The Prisma Schema File</li>
    <br/>
    <ul>
        <li>The <code>schema.prisma</code> file defines your database structure:</li>
<pre><code class="language-prisma line-numbers">// Data source configuration
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Generator configuration
generator client {
  provider = "prisma-client-js"
}

// Data model
model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
  posts Post[]
}

model Post {
  id        Int      @id @default(autoincrement())
  title     String
  content   String?
  published Boolean  @default(false)
  authorId  Int
  author    User     @relation(fields: [authorId], references: [id])
}</code></pre>
        <br/>
        <li>Schema components:</li>
<table>
    <thead>
        <tr>
            <th>Component</th>
            <th>Purpose</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>datasource</code></td>
            <td>Database connection configuration</td>
        </tr>
        <tr>
            <td><code>generator</code></td>
            <td>Specifies what to generate (Prisma Client, etc.)</td>
        </tr>
        <tr>
            <td><code>model</code></td>
            <td>Defines database tables/collections</td>
        </tr>
        <tr>
            <td><code>enum</code></td>
            <td>Defines enumeration types</td>
        </tr>
    </tbody>
</table>
    </ul>
    <br/><br/>


    <li>Creating Your First Model</li>
    <br/>
    <ul>
        <li>Define a simple User model:</li>
<pre><code class="language-prisma line-numbers">model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}</code></pre>
        <br/>
        <li>Field type modifiers:</li>
<table>
    <thead>
        <tr>
            <th>Modifier</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>@id</code></td>
            <td>Defines primary key</td>
        </tr>
        <tr>
            <td><code>@unique</code></td>
            <td>Ensures field values are unique</td>
        </tr>
        <tr>
            <td><code>@default()</code></td>
            <td>Sets default value</td>
        </tr>
        <tr>
            <td><code>@updatedAt</code></td>
            <td>Automatically updates on record modification</td>
        </tr>
        <tr>
            <td><code>?</code></td>
            <td>Makes field optional (nullable)</td>
        </tr>
        <tr>
            <td><code>[]</code></td>
            <td>Defines array/list type</td>
        </tr>
    </tbody>
</table>
        <br/>
        <li>Common field types:</li>
<pre><code class="language-prisma line-numbers">model Example {
  id        Int      @id
  text      String
  number    Int
  decimal   Float
  boolean   Boolean
  date      DateTime
  json      Json
  bytes     Bytes
}</code></pre>
    </ul>
    <br/><br/>


    <li>Generating Prisma Client</li>
    <br/>
    <ul>
        <li>After defining your schema, generate the Prisma Client:</li>
<pre><code class="language-bash line-numbers">npx prisma generate</code></pre>
        <br/>
        <li>This generates a type-safe client in <code>node_modules/@prisma/client</code>.</li>
        <br/>
        <li>The client is automatically regenerated when you run migrations.</li>
        <br/>
        <li>Import and use the client in your code:</li>
<pre><code class="language-typescript line-numbers">import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  const user = await prisma.user.create({
    data: {
      email: 'alice@example.com',
      name: 'Alice'
    }
  })
  console.log(user)
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect())</code></pre>
    </ul>
    <br/><br/>


    <li>Database Migrations</li>
    <br/>
    <ul>
        <li>Create and apply migrations during development:</li>
<pre><code class="language-bash line-numbers">npx prisma migrate dev --name init</code></pre>
        <br/>
        <li>This command:</li>
        <ul>
            <li>creates a new migration file</li>
            <li>applies the migration to the database</li>
            <li>regenerates Prisma Client</li>
        </ul>
        <br/>
        <li>Migration files are stored in:</li>
<pre><code class="language-plaintext line-numbers">prisma/
└── migrations/
    └── 20240101000000_init/
        └── migration.sql</code></pre>
        <br/>
        <li>Apply migrations in production:</li>
<pre><code class="language-bash line-numbers">npx prisma migrate deploy</code></pre>
        <br/>
        <li>View migration status:</li>
<pre><code class="language-bash line-numbers">npx prisma migrate status</code></pre>
        <br/>
        <li>Reset database (caution - deletes all data):</li>
<pre><code class="language-bash line-numbers">npx prisma migrate reset</code></pre>
    </ul>
    <br/><br/>


    <li>Basic CRUD Operations</li>
    <br/>
    <ul>
        <li><b>Create:</b> Insert new records</li>
<pre><code class="language-typescript line-numbers">const user = await prisma.user.create({
  data: {
    email: 'alice@example.com',
    name: 'Alice'
  }
})</code></pre>
        <br/>
        <li><b>Read:</b> Query records</li>
<pre><code class="language-typescript line-numbers">// Find unique record
const user = await prisma.user.findUnique({
  where: { email: 'alice@example.com' }
})

// Find many records
const users = await prisma.user.findMany({
  where: { name: { contains: 'Alice' } }
})

// Find first matching record
const user = await prisma.user.findFirst({
  where: { email: 'alice@example.com' }
})</code></pre>
        <br/>
        <li><b>Update:</b> Modify existing records</li>
<pre><code class="language-typescript line-numbers">const user = await prisma.user.update({
  where: { id: 1 },
  data: { name: 'Alice Updated' }
})</code></pre>
        <br/>
        <li><b>Delete:</b> Remove records</li>
<pre><code class="language-typescript line-numbers">const user = await prisma.user.delete({
  where: { id: 1 }
})</code></pre>
    </ul>
    <br/><br/>


    <li>Prisma Studio</li>
    <br/>
    <ul>
        <li>Prisma Studio is a visual database browser and editor.</li>
        <br/>
        <li>Start Prisma Studio:</li>
<pre><code class="language-bash line-numbers">npx prisma studio</code></pre>
        <br/>
        <li>This opens a web interface (usually at <code>http://localhost:5555</code>).</li>
    </ul>
    <br/><br/>


    <li>Introspection</li>
    <br/>
    <ul>
        <li>Prisma can introspect existing databases to generate a schema:</li>
<pre><code class="language-bash line-numbers">npx prisma db pull</code></pre>
        <br/>
        <li>This command:</li>
        <ul>
            <li>connects to your database</li>
            <li>analyzes the database schema</li>
            <li>generates corresponding Prisma models</li>
        </ul>
        <br/>
        <li>Useful when:</li>
        <ul>
            <li>adding Prisma to an existing project</li>
            <li>working with a legacy database</li>
            <li>synchronizing schema after manual database changes</li>
        </ul>
        <br/>
        <li>Example workflow with existing database:</li>
<pre><code class="language-bash line-numbers"># 1. Initialize Prisma
npx prisma init

# 2. Configure DATABASE_URL in .env

# 3. Introspect database
npx prisma db pull

# 4. Generate Prisma Client
npx prisma generate</code></pre>
    </ul>
    <br/><br/>
</ol>
<!-- * * * * * * * * * * * * * * -->


<hr/>


<!-- * * * * * * * * * * * * * * -->
<h3 id="prisma-database-connections">Database Connection Configuration</h3>
<ol>

    <li>Basic Connection String</li>
    <br/>
    <ul>
        <li>Database connection is configured in <code>.env</code> file:</li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="provider://user:password@host:port/database?options"</code></pre>
        <br/>
        <li>Referenced in <code>schema.prisma</code>:</li>
<pre><code class="language-prisma line-numbers">datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}</code></pre>
    </ul>
    <br/><br/>


    <li>Connection Strings by Database</li>
    <br/>
    <ul>
        <li><b>PostgreSQL:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:password@localhost:5432/mydb?schema=public"</code></pre>
        <br/>
        <li><b>MySQL:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="mysql://user:password@localhost:3306/mydb"</code></pre>
        <br/>
        <li><b>SQLite:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="file:./dev.db"</code></pre>
        <br/>
        <li><b>SQL Server:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="sqlserver://localhost:1433;database=mydb;user=sa;password=Pass123;encrypt=true"</code></pre>
        <br/>
        <li><b>MongoDB:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="mongodb+srv://user:password@cluster.mongodb.net/mydb?retryWrites=true"</code></pre>
        <br/>
        <li><b>CockroachDB:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:password@host:26257/mydb?sslmode=verify-full"</code></pre>
    </ul>
    <br/><br/>


    <li>Connection Parameters</li>
    <br/>
    <ul>
        <li>PostgreSQL parameters:</li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:pass@localhost:5432/db?schema=public&connection_limit=10&pool_timeout=20&sslmode=require"</code></pre>
        <br/>
<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>schema</code></td>
            <td>PostgreSQL schema name (default: <code>public</code>)</td>
        </tr>
        <tr>
            <td><code>connection_limit</code></td>
            <td>Max number of connections in pool</td>
        </tr>
        <tr>
            <td><code>pool_timeout</code></td>
            <td>Seconds to wait for connection (default: 10)</td>
        </tr>
        <tr>
            <td><code>sslmode</code></td>
            <td><code>disable</code>, <code>prefer</code>, <code>require</code></td>
        </tr>
        <tr>
            <td><code>sslcert</code></td>
            <td>Path to SSL certificate</td>
        </tr>
        <tr>
            <td><code>connect_timeout</code></td>
            <td>Seconds to wait for initial connection</td>
        </tr>
    </tbody>
</table>
        <br/>
        <li>MySQL parameters:</li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="mysql://user:pass@localhost:3306/db?connection_limit=10&socket_timeout=10&ssl=true"</code></pre>
        <br/>
<table>
    <thead>
        <tr>
            <th>Parameter</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>connection_limit</code></td>
            <td>Max connections in pool</td>
        </tr>
        <tr>
            <td><code>socket_timeout</code></td>
            <td>Seconds before socket timeout</td>
        </tr>
        <tr>
            <td><code>ssl</code></td>
            <td>SSL/TLS configuration</td>
        </tr>
        <tr>
            <td><code>sslcert</code></td>
            <td>Path to SSL certificate</td>
        </tr>
    </tbody>
</table>
    </ul>
    <br/><br/>


    <li>Connection Pooling</li>
    <br/>
    <ul>
        <li>Set connection pool size:</li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:pass@localhost:5432/db?connection_limit=20"</code></pre>
        <br/>
        <li>Default pool sizes by database:</li>
<table>
    <thead>
        <tr>
            <th>Database</th>
            <th>Default Pool Size</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>PostgreSQL</td>
            <td>num_cpus * 2 + 1</td>
        </tr>
        <tr>
            <td>MySQL</td>
            <td>num_cpus * 2 + 1</td>
        </tr>
        <tr>
            <td>SQL Server</td>
            <td>num_cpus * 2 + 1</td>
        </tr>
        <tr>
            <td>SQLite</td>
            <td>1 (no pooling)</td>
        </tr>
    </tbody>
</table>
        <br/>
        <li>Configure pool behavior:</li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:pass@localhost:5432/db?connection_limit=50&pool_timeout=30"</code></pre>
    </ul>
    <br/><br/>


    <li>SSL/TLS Configuration</li>
    <br/>
    <ul>
        <li>PostgreSQL SSL modes:</li>
<pre><code class="language-plaintext line-numbers"># Disable SSL
DATABASE_URL="postgresql://user:pass@localhost:5432/db?sslmode=disable"

# Prefer SSL but allow non-SSL
DATABASE_URL="postgresql://user:pass@localhost:5432/db?sslmode=prefer"

# Require SSL
DATABASE_URL="postgresql://user:pass@localhost:5432/db?sslmode=require"

# Require SSL with certificate verification
DATABASE_URL="postgresql://user:pass@localhost:5432/db?sslmode=verify-full&sslcert=./cert.pem&sslidentity=./identity.p12&sslpassword=password"</code></pre>
        <br/>
        <li>MySQL SSL:</li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="mysql://user:pass@localhost:3306/db?ssl=true&sslcert=./cert.pem"</code></pre>
        <br/>
        <li>Certificate-based authentication:</li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user@localhost:5432/db?sslmode=require&sslcert=/path/to/client-cert.pem&sslkey=/path/to/client-key.pem&sslrootcert=/path/to/ca-cert.pem"</code></pre>
    </ul>
    <br/><br/>


    <li>Environment-Specific Configuration</li>
    <br/>
    <ul>
        <li>Use different URLs per environment:</li>
<pre><code class="language-plaintext line-numbers"># .env.development
DATABASE_URL="postgresql://localhost:5432/mydb_dev"

# .env.test
DATABASE_URL="postgresql://localhost:5432/mydb_test"

# .env.production
DATABASE_URL="postgresql://prod-host:5432/mydb?connection_limit=100&sslmode=require"</code></pre>
        <br/>
        <li>Runtime environment variable:</li>
<pre><code class="language-typescript line-numbers">import { PrismaClient } from '@prisma/client'

const databaseUrl = process.env.NODE_ENV === 'test'
  ? process.env.TEST_DATABASE_URL
  : process.env.DATABASE_URL

const prisma = new PrismaClient({
  datasources: {
    db: {
      url: databaseUrl
    }
  }
})</code></pre>
    </ul>
    <br/><br/>


    <li>Connection URL from Multiple Sources</li>
    <br/>
    <ul>
        <li>Override in schema:</li>
<pre><code class="language-prisma line-numbers">datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Optional: direct URL for migrations
  directUrl = env("DIRECT_DATABASE_URL")
}</code></pre>
        <br/>
        <li>Override at runtime:</li>
<pre><code class="language-typescript line-numbers">const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.CUSTOM_DATABASE_URL
    }
  }
})</code></pre>
        <br/>
        <li>Build connection URL dynamically:</li>
<pre><code class="language-typescript line-numbers">const host = process.env.DB_HOST
const port = process.env.DB_PORT
const user = process.env.DB_USER
const password = process.env.DB_PASSWORD
const database = process.env.DB_NAME

const url = `postgresql://${user}:${password}@${host}:${port}/${database}?schema=public`

const prisma = new PrismaClient({
  datasources: { db: { url } }
})</code></pre>
    </ul>
    <br/><br/>


    <li>Connection Pooling vs Direct Connection</li>
    <br/>
    <ul>
        <li>Use <code>directUrl</code> for migrations with connection poolers:</li>
<pre><code class="language-prisma line-numbers">datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")        // Pooled connection
  directUrl = env("DIRECT_DATABASE_URL") // Direct connection for migrations
}</code></pre>
        <br/>
        <li>Example with PgBouncer:</li>
<pre><code class="language-plaintext line-numbers"># Pooled connection (application queries)
DATABASE_URL="postgresql://user:pass@pgbouncer:6432/db?pgbouncer=true"

# Direct connection (migrations)
DIRECT_DATABASE_URL="postgresql://user:pass@postgres:5432/db"</code></pre>
        <br/>
        <li>PlanetScale example:</li>
<pre><code class="language-prisma line-numbers">datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma" // Required for PlanetScale
}</code></pre>
    </ul>
    <br/><br/>


    <li>Shadow Database</li>
    <br/>
    <ul>
        <li>Configure shadow database for development migrations:</li>
<pre><code class="language-prisma line-numbers">datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}</code></pre>
        <br/>
        <li>Environment variables:</li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:pass@localhost:5432/mydb"
SHADOW_DATABASE_URL="postgresql://user:pass@localhost:5432/mydb_shadow"</code></pre>
        <br/>
        <li>Required when:</li>
        <ul>
            <li>database provider doesn't support automatic shadow database creation</li>
            <li>insufficient permissions to create databases</li>
            <li>using managed database services with restrictions</li>
        </ul>
    </ul>
    <br/><br/>


    <li>Read Replicas</li>
    <br/>
    <ul>
        <li>Configure read replicas (Prisma 5.0+):</li>
<pre><code class="language-prisma line-numbers">datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [
    {
      name = "read_replicas"
      url  = env("READ_REPLICA_URL")
    }
  ]
}</code></pre>
        <br/>
        <li>Use read replicas in code:</li>
<pre><code class="language-typescript line-numbers">// Write to primary
await prisma.user.create({
  data: { email: 'user@example.com' }
})

// Read from replica
const users = await prisma.user.findMany().$replica()</code></pre>
    </ul>
    <br/><br/>


    <li>Connection Timeouts</li>
    <br/>
    <ul>
        <li>Configure various timeout values:</li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:pass@localhost:5432/db?connect_timeout=10&pool_timeout=20&socket_timeout=30"</code></pre>
        <br/>
<table>
    <thead>
        <tr>
            <th>Timeout Type</th>
            <th>Parameter</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Connect</td>
            <td><code>connect_timeout</code></td>
            <td>Seconds to wait for initial connection</td>
        </tr>
        <tr>
            <td>Pool</td>
            <td><code>pool_timeout</code></td>
            <td>Seconds to wait for connection from pool</td>
        </tr>
        <tr>
            <td>Socket</td>
            <td><code>socket_timeout</code></td>
            <td>Seconds to wait for query response</td>
        </tr>
    </tbody>
</table>
    </ul>
    <br/><br/>


    <li>Special Characters in Connection String</li>
    <br/>
    <ul>
        <li>URL-encode special characters in passwords:</li>
<pre><code class="language-typescript line-numbers">// Password: p@ss:word/123
// Encoded: p%40ss%3Aword%2F123
DATABASE_URL="postgresql://user:p%40ss%3Aword%2F123@localhost:5432/db"</code></pre>
        <br/>
        <li>Common encodings:</li>
<table>
    <thead>
        <tr>
            <th>Character</th>
            <th>Encoded</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>@</code></td>
            <td><code>%40</code></td>
        </tr>
        <tr>
            <td><code>:</code></td>
            <td><code>%3A</code></td>
        </tr>
        <tr>
            <td><code>/</code></td>
            <td><code>%2F</code></td>
        </tr>
        <tr>
            <td><code>?</code></td>
            <td><code>%3F</code></td>
        </tr>
        <tr>
            <td><code>#</code></td>
            <td><code>%23</code></td>
        </tr>
        <tr>
            <td><code>&</code></td>
            <td><code>%26</code></td>
        </tr>
        <tr>
            <td><code>=</code></td>
            <td><code>%3D</code></td>
        </tr>
    </tbody>
</table>
        <br/>
        <li>Encode programmatically:</li>
<pre><code class="language-typescript line-numbers">const password = "p@ss:word"
const encoded = encodeURIComponent(password)
const url = `postgresql://user:${encoded}@localhost:5432/db`</code></pre>
    </ul>
    <br/><br/>


    <li>Connection String Templates</li>
    <br/>
    <ul>
        <li><b>Local development:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://postgres:postgres@localhost:5432/mydb?schema=public"</code></pre>
        <br/>
        <li><b>Docker Compose:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://postgres:postgres@db:5432/mydb?schema=public"</code></pre>
        <br/>
        <li><b>Heroku:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:pass@ec2-host.compute-1.amazonaws.com:5432/db?sslmode=require"</code></pre>
        <br/>
        <li><b>AWS RDS:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:pass@mydb.123456.us-east-1.rds.amazonaws.com:5432/mydb?sslmode=require"</code></pre>
        <br/>
        <li><b>Supabase:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://postgres:pass@db.project.supabase.co:5432/postgres?pgbouncer=true"
DIRECT_DATABASE_URL="postgresql://postgres:pass@db.project.supabase.co:5432/postgres"</code></pre>
        <br/>
        <li><b>Railway:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:pass@containers-us-west-123.railway.app:5432/railway"</code></pre>
        <br/>
        <li><b>Neon:</b></li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:pass@ep-cool-name-123456.us-east-2.aws.neon.tech/neondb?sslmode=require"</code></pre>
    </ul>
    <br/><br/>


    <li>Testing Connection</li>
    <br/>
    <ul>
        <li>Test database connection:</li>
<pre><code class="language-typescript line-numbers">import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function testConnection() {
  try {
    await prisma.$connect()
    console.log('Database connection successful')
  } catch (error) {
    console.error('Database connection failed:', error)
  } finally {
    await prisma.$disconnect()
  }
}

testConnection()</code></pre>
        <br/>
        <li>Execute raw query to test:</li>
<pre><code class="language-typescript line-numbers">const result = await prisma.$queryRaw`SELECT 1`
console.log('Connection test:', result)</code></pre>
    </ul>
    <br/><br/>


    <li>Common Connection Issues</li>
    <br/>
    <ul>
        <li>Connection refused:</li>
<pre><code class="language-plaintext line-numbers">Error: Can't reach database server at `localhost:5432`

Solutions:
- Check if database is running
- Verify host and port
- Check firewall rules</code></pre>
        <br/>
        <li>Authentication failed:</li>
<pre><code class="language-plaintext line-numbers">Error: Authentication failed against database server

Solutions:
- Verify username and password
- Check user permissions
- Ensure URL encoding for special characters</code></pre>
        <br/>
        <li>Database does not exist:</li>
<pre><code class="language-plaintext line-numbers">Error: Database `mydb` does not exist

Solutions:
- Create database manually
- Check database name in connection string
- Run migrations to create schema</code></pre>
        <br/>
        <li>SSL required:</li>
<pre><code class="language-plaintext line-numbers">Error: SSL connection is required

Solution:
DATABASE_URL="postgresql://user:pass@host:5432/db?sslmode=require"</code></pre>
        <br/>
        <li>Connection pool exhausted:</li>
<pre><code class="language-plaintext line-numbers">Error: Timed out fetching a connection from the pool

Solutions:
- Increase connection_limit
- Ensure connections are properly closed
- Check for connection leaks</code></pre>
    </ul>
    <br/><br/>


    <li>Multiple Database Connections</li>
    <br/>
    <ul>
        <li>Multiple Prisma instances for different databases:</li>
<pre><code class="language-typescript line-numbers">// lib/prisma-main.ts
import { PrismaClient } from '@prisma/client'

export const prismaMain = new PrismaClient({
  datasources: {
    db: { url: process.env.MAIN_DATABASE_URL }
  }
})

// lib/prisma-analytics.ts
import { PrismaClient } from '@prisma/client'

export const prismaAnalytics = new PrismaClient({
  datasources: {
    db: { url: process.env.ANALYTICS_DATABASE_URL }
  }
})</code></pre>
        <br/>
        <li>Multiple schemas (PostgreSQL):</li>
<pre><code class="language-prisma line-numbers">// schema1.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "auth"]
}

model User {
  id    Int    @id
  email String

  @@schema("auth")
}

model Post {
  id    Int    @id
  title String

  @@schema("public")
}</code></pre>
    </ul>
    <br/>
</ol>
<!-- * * * * * * * * * * * * * * -->


<hr/>


<!-- * * * * * * * * * * * * * * -->
<h3 id="prisma-connection-pooling">Connection Pooling vs Direct Connection</h3>
<ol>

    <li>What Is Connection Pooling?</li>
    <br/>
    <ul>
        <li>A <b>connection pool</b> maintains a set of reusable database connections instead of creating new connections for each request.</li>
        <br/>
        <li>Connection lifecycle:</li>
<pre><code class="language-plaintext line-numbers">Without pooling:
Request → Create Connection → Execute Query → Close Connection → Response
(Expensive: ~20-50ms overhead per request)

With pooling:
Request → Get Connection from Pool → Execute Query → Return to Pool → Response
(Fast: ~1-2ms overhead per request)</code></pre>
        <br/>
        <li>Built-in pooling in Prisma:</li>
        <ul>
            <li>Prisma Client includes connection pooling by default</li>
            <li>pool size defaults to <code>(num_cpus * 2) + 1</code></li>
            <li>connections are kept alive and reused</li>
        </ul>
    </ul>
    <br/><br/>


    <li>Direct Connection vs Pooled Connection</li>
    <br/>
    <ul>
<table>
    <thead>
        <tr>
            <th>Aspect</th>
            <th>Direct Connection</th>
            <th>Pooled Connection</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><b>Connection Creation</b></td>
            <td>Per request</td>
            <td>Reused from pool</td>
        </tr>
        <tr>
            <td><b>Latency</b></td>
            <td>Higher (20-50ms overhead)</td>
            <td>Lower (1-2ms overhead)</td>
        </tr>
        <tr>
            <td><b>Database Load</b></td>
            <td>High (many connections)</td>
            <td>Low (controlled connections)</td>
        </tr>
        <tr>
            <td><b>Scalability</b></td>
            <td>Limited by max connections</td>
            <td>Better (pool manages connections)</td>
        </tr>
        <tr>
            <td><b>Features</b></td>
            <td>All database features</td>
            <td>May have limitations</td>
        </tr>
        <tr>
            <td><b>Migrations</b></td>
            <td>Supported</td>
            <td>Often not supported</td>
        </tr>
        <tr>
            <td><b>Prepared Statements</b></td>
            <td>Fully supported</td>
            <td>Limited in transaction mode</td>
        </tr>
    </tbody>
</table>
    </ul>
    <br/><br/>


    <li>Configuring Both in Prisma</li>
    <br/>
    <ul>
        <li>Use <code>url</code> for pooled, <code>directUrl</code> for direct:</li>
<pre><code class="language-prisma line-numbers">datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")        // Pooled connection
  directUrl = env("DIRECT_DATABASE_URL") // Direct connection
}</code></pre>
        <br/>
        <li>Environment variables:</li>
<pre><code class="language-plaintext line-numbers"># Pooled connection (via PgBouncer)
DATABASE_URL="postgresql://user:pass@pgbouncer:6432/mydb?pgbouncer=true"

# Direct connection (to PostgreSQL)
DIRECT_DATABASE_URL="postgresql://user:pass@postgres:5432/mydb"</code></pre>
        <br/>
        <li>Behavior:</li>
        <ul>
            <li><code>url</code> - used for queries (<code>prisma.user.findMany()</code>)</li>
            <li><code>directUrl</code> - used for migrations (<code>prisma migrate</code>)</li>
        </ul>
    </ul>
    <br/><br/>


    <li>PgBouncer Configuration</li>
    <br/>
    <ul>
        <li>PgBouncer is a popular PostgreSQL connection pooler.</li>
        <br/>
        <li>Connection modes:</li>
<table>
    <thead>
        <tr>
            <th>Mode</th>
            <th>Description</th>
            <th>Use Case</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>session</code></td>
            <td>Connection held for entire session</td>
            <td>Full PostgreSQL feature support</td>
        </tr>
        <tr>
            <td><code>transaction</code></td>
            <td>Connection held for transaction</td>
            <td>Most common, good performance</td>
        </tr>
        <tr>
            <td><code>statement</code></td>
            <td>Connection returned after each statement</td>
            <td>Maximum connection reuse</td>
        </tr>
    </tbody>
</table>
        <br/>
        <li>Basic PgBouncer setup:</li>
<pre><code class="language-ini line-numbers"># pgbouncer.ini
[databases]
mydb = host=postgres port=5432 dbname=mydb

[pgbouncer]
listen_port = 6432
listen_addr = *
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 20</code></pre>
        <br/>
        <li>Prisma configuration:</li>
<pre><code class="language-plaintext line-numbers">DATABASE_URL="postgresql://user:pass@localhost:6432/mydb?pgbouncer=true"
DIRECT_DATABASE_URL="postgresql://user:pass@localhost:5432/mydb"</code></pre>
        <br/>
        <li>The <code>?pgbouncer=true</code> parameter tells Prisma to use transaction mode optimizations.</li>
    </ul>
    <br/><br/>


    <li>Connection Pool Exhaustion</li>
    <br/>
    <ul>
        <li>Common problem when pool size is too small:</li>
<pre><code class="language-plaintext line-numbers">Error: Timed out fetching a new connection from the connection pool.
More info: http://pris.ly/d/connection-pool</code></pre>
        <br/>
        <li>Causes:</li>
        <ul>
            <li>too many concurrent requests</li>
            <li>connections not being released</li>
            <li>long-running queries</li>
            <li>connection leaks</li>
        </ul>
        <br/>
        <li>Solutions:</li>
<pre><code class="language-plaintext line-numbers"># Increase pool size
DATABASE_URL="postgresql://user:pass@host:5432/db?connection_limit=50"

# Increase pool timeout
DATABASE_URL="postgresql://user:pass@host:5432/db?pool_timeout=30"</code></pre>
        <br/>
        <li>Always disconnect in scripts:</li>
<pre><code class="language-typescript line-numbers">async function script() {
  try {
    // Your database operations
  } finally {
    await prisma.$disconnect()  // Release connections
  }
}</code></pre>
        <br/>
        <li>Check for connection leaks:</li>
<pre><code class="language-typescript line-numbers">// Bad - connection leak
async function badExample() {
  const prisma = new PrismaClient()
  const users = await prisma.user.findMany()
  return users  // Never disconnects!
}

// Good - proper cleanup
const prisma = new PrismaClient()  // Singleton
async function goodExample() {
  const users = await prisma.user.findMany()
  return users  // Prisma instance managed globally
}</code></pre>
    </ul>
    <br/><br/>


    <li>Calculating Optimal Pool Size</li>
    <br/>
    <ul>
        <li>Formula for traditional servers:</li>
<pre><code class="language-plaintext line-numbers">pool_size = (num_cores * 2) + effective_spindle_count

Example: 4 cores, 1 disk = (4 * 2) + 1 = 9 connections</code></pre>
        <br/>
        <li>Serverless considerations:</li>
<pre><code class="language-plaintext line-numbers">max_connections = max_concurrent_invocations * connection_limit

Example:
- 100 concurrent Lambda invocations
- connection_limit = 1 per invocation
- Total = 100 connections needed

Solution: Use connection pooler to reduce to 10-20 actual connections</code></pre>
        <br/>
        <li>Configure per environment:</li>
<pre><code class="language-plaintext line-numbers"># Development (single developer)
DATABASE_URL="postgresql://user:pass@localhost:5432/db?connection_limit=5"

# Production (high traffic)
DATABASE_URL="postgresql://user:pass@host:5432/db?connection_limit=50"

# Serverless (via pooler)
DATABASE_URL="postgresql://user:pass@pooler:6432/db?connection_limit=1"</code></pre>
    </ul>
    <br/><br/>


    <li>Monitoring Connection Usage</li>
    <br/>
    <ul>
        <li>Check active connections in PostgreSQL:</li>
<pre><code class="language-sql line-numbers">SELECT count(*)
FROM pg_stat_activity
WHERE state = 'active';</code></pre>
        <br/>
        <li>View connection pool metrics in Prisma:</li>
<pre><code class="language-typescript line-numbers">import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient({
  log: [
    { level: 'query', emit: 'event' },
    { level: 'info', emit: 'event' },
  ]
})

prisma.$on('query', (e) =&gt; {
  console.log('Query:', e.query)
  console.log('Duration:', e.duration, 'ms')
})

// Check pool metrics
const metrics = await prisma.$metrics.json()
console.log(metrics)</code></pre>
        <br/>
        <li>Monitor pool exhaustion events:</li>
<pre><code class="language-typescript line-numbers">prisma.$on('info', (e) => {
  if (e.message.includes('pool timeout')) {
    console.error('Pool exhausted:', e)
    // Alert or scale up
  }
})</code></pre>
    </ul>
    <br/><br/>


    <li>Migration Strategies</li>
    <br/>
    <ul>
        <li>Always use direct connection for migrations:</li>
<pre><code class="language-bash line-numbers"># This uses directUrl automatically
npx prisma migrate deploy</code></pre>
        <br/>
        <li>If no <code>directUrl</code> configured:</li>
<pre><code class="language-bash line-numbers"># Temporarily set direct connection
DATABASE_URL="postgresql://user:pass@postgres:5432/db" npx prisma migrate deploy</code></pre>
        <br/>
        <li>CI/CD pipeline example:</li>
<pre><code class="language-yaml line-numbers"># GitHub Actions
- name: Run migrations
  env:
    DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
  run: npx prisma migrate deploy</code></pre>
        <br/>
        <li>Docker Compose setup:</li>
<pre><code class="language-yaml line-numbers">services:
  postgres:
    image: postgres:15
    ports:
      - "5432:5432"

  pgbouncer:
    image: pgbouncer/pgbouncer
    depends_on:
      - postgres
    ports:
      - "6432:6432"

  app:
    environment:
      DATABASE_URL: "postgresql://user:pass@pgbouncer:6432/db?pgbouncer=true"
      DIRECT_DATABASE_URL: "postgresql://user:pass@postgres:5432/db"</code></pre>
    </ul>
    <br/><br/>
</ol>
<!-- * * * * * * * * * * * * * * -->


<hr/>


<!-- * * * * * * * * * * * * * * -->

<!-- * * * * * * * * * * * * * * -->


<hr/>


<!-- * * * * * * * * * * * * * * -->

<!-- * * * * * * * * * * * * * * -->


<hr/>
<!-- * * * * * * * * * * * * * * -->

<footer>
    <p>&copy; 2025 Hwangfucius. All rights reserved.</p>
</footer>
</body>
<!-- * * * * * * * * * * * * * * -->
</html>
<!-- * * * * * * * * * * * * * * -->
